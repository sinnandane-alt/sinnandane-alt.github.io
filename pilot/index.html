<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoreFlow AI - ë§¤ì¥ ë™ì„  ìµœì í™” ì‹œë®¬ë ˆì´í„°</title>
    
    <!-- React & ReactDOM (Core) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (JSX Transformer) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Pretendard Font -->
    <style>
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");
        body { 
            font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif; 
        }
        .canvas-grid {
            background-size: 40px 40px;
            background-image:
                linear-gradient(to right, #f0f0f0 1px, transparent 1px),
                linear-gradient(to bottom, #f0f0f0 1px, transparent 1px);
        }
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">
    <div id="root"></div>

    <!-- Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.body.innerHTML = `
                <div style="padding:20px; color:#ef4444; font-family:sans-serif;">
                    <h2 style="font-weight:bold; margin-bottom:10px;">âš ï¸ ì‹¤í–‰ ì˜¤ë¥˜ ë°œìƒ</h2>
                    <p>${msg}</p>
                    <p style="font-size:0.8em; color:#666;">${url}:${line}</p>
                </div>
            `;
            return false;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (Inlined) ---
        const Icon = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>;
        const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
        const Pause = (props) => <Icon {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></Icon>;
        const RotateCw = (props) => <Icon {...props}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></Icon>;
        const Layout = (props) => <Icon {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></Icon>;
        const FileText = (props) => <Icon {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;
        const TrendingUp = (props) => <Icon {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></Icon>;
        const Users = (props) => <Icon {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;
        const ArrowRight = (props) => <Icon {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const RefreshCw = (props) => <Icon {...props}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>;
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></Icon>;


        // --- Mock Data ---
        const DETAILED_SCORES = {
            before: [
                { category: "ì´ë™ íš¨ìœ¨ì„±", score: 12, max: 20, status: "Bad", analysis: "ì£¼ë°© ê¹Šì´(3.5m)ë¡œ ì¸í•œ ì¡°ë¦¬-í”½ì—… ê°„ ë¶ˆí•„ìš”í•œ ë³´í–‰ ë°œìƒ", improvement: "ì£¼ë°© ê°€ë¡œ ë°°ì¹˜ ë³€ê²½ìœ¼ë¡œ ì´ë™ ê±°ë¦¬ ë‹¨ì¶• í•„ìš”" },
                { category: "ë™ì„  ì¶©ëŒ(í˜¼ì¡ë„)", score: 10, max: 20, status: "Bad", analysis: "í…Œë¼ìŠ¤ ì„œë¹™ ì‹œ í™€ ì¤‘ì•™ í…Œì´ë¸”ê³¼ ë™ì„ ì´ 42íšŒ êµì°¨ë¨", improvement: "ë©”ì¸ í†µë¡œ í™•ë³´ë¥¼ ìœ„í•œ í…Œì´ë¸” 45ë„ íšŒì „ ë°°ì¹˜" },
                { category: "ì£¼ë°© ì‘ì—…ì„±", score: 15, max: 20, status: "Normal", analysis: "ëƒ‰ì¥ê³ -ê·¸ë¦´-ì¡°ë¦¬ëŒ€ ë°°ì¹˜ëŠ” í‘œì¤€ì´ë‚˜ ê°„ê²©ì´ ë„ˆë¬´ ë„“ìŒ", improvement: "ì‚¼ê° ë™ì„ (Work Triangle) ìµœì í™”ë¥¼ ìœ„í•´ ê¸°ê¸° ê°„ê²© ì¡°ì •" },
                { category: "ì„œë¹„ìŠ¤ ì‹ ì†ì„±", score: 18, max: 25, status: "Normal", analysis: "í”¼í¬íƒ€ì„(12ì‹œ) ëŒ€ê¸°ì‹œê°„ í‰ê·  24ë¶„ ì†Œìš”", improvement: "ìŒë£Œ ë””ìŠ¤íœì„œ ì „ì§„ ë°°ì¹˜ë¡œ í™€ ì§ì› ë™ì„  ë¶„ë¦¬" },
                { category: "ê³µê°„ í™œìš©ë„", score: 13, max: 15, status: "Good", analysis: "ë°ë“œ ìŠ¤í˜ì´ìŠ¤ëŠ” ê±°ì˜ ì—†ìœ¼ë‚˜ ì—¬ìœ  ê³µê°„ ë¶€ì¡±", improvement: "í‡´ì‹êµ¬ ìœ„ì¹˜ ë³€ê²½ìœ¼ë¡œ ì…êµ¬ í˜¼ì¡ ì™„í™”" },
            ],
            after: [
                { category: "ì´ë™ íš¨ìœ¨ì„±", score: 18, max: 20, status: "Good", analysis: "ì£¼ë°© ê°€ë¡œ ë°°ì¹˜ë¡œ ì¡°ë¦¬ ë™ì„  45% ë‹¨ì¶•", improvement: "ìµœì í™” ì™„ë£Œ" },
                { category: "ë™ì„  ì¶©ëŒ(í˜¼ì¡ë„)", score: 18, max: 20, status: "Good", analysis: "ì¤‘ì•™ í†µë¡œ í™•ë³´ë¡œ êµì°¨ íšŸìˆ˜ 5íšŒ ë¯¸ë§Œìœ¼ë¡œ ê°ì†Œ", improvement: "ìµœì í™” ì™„ë£Œ" },
                { category: "ì£¼ë°© ì‘ì—…ì„±", score: 19, max: 20, status: "Good", analysis: "ê¸°ê¸° ê°„ê²© 1.2m ìœ ì§€ë¡œ íšŒì „ ë°˜ê²½ ìµœì í™”", improvement: "ìµœì í™” ì™„ë£Œ" },
                { category: "ì„œë¹„ìŠ¤ ì‹ ì†ì„±", score: 22, max: 25, status: "Good", analysis: "ìŒë£Œ/í‡´ì‹ ë™ì„  ë¶„ë¦¬ë¡œ ëŒ€ê¸°ì‹œê°„ 11ë¶„ ë‹¨ì¶•", improvement: "ìµœì í™” ì™„ë£Œ" },
                { category: "ê³µê°„ í™œìš©ë„", score: 12, max: 15, status: "Normal", analysis: "í†µë¡œ í™•ë³´ë¡œ ì¸í•´ ì¢Œì„ ìˆ˜ëŠ” ìœ ì§€í•˜ë˜ ê°„ê²©ì€ ì¢ì•„ì§", improvement: "2ì¸ í…Œì´ë¸” í™œìš© ì œì•ˆ" },
            ]
        };

        const SIMULATION_LOGS = [
            { time: "12:10:05", event: "ì£¼ë¬¸ ì ‘ìˆ˜: ê°ˆë¹„ë²„ê±° SET (í‚¤ì˜¤ìŠ¤í¬ 1)", type: "order" },
            { time: "12:10:15", event: "ì¡°ë¦¬ ì‹œì‘: ê·¸ë¦´ ì„¹ì…˜ (ì§ì› A)", type: "cook" },
            { time: "12:10:45", event: "âš  ë™ì„  ì¶©ëŒ ê°ì§€: ì£¼ë°© ì…êµ¬ (ì§ì› A <-> ì§ì› B)", type: "warning" },
            { time: "12:12:30", event: "ì„œë¹™ ì™„ë£Œ: í…Œì´ë¸” 4 (ì§ì› B)", type: "serve" },
            { time: "12:13:00", event: "í‡´ì‹ ì²˜ë¦¬: í…Œë¼ìŠ¤ êµ¬ì—­ (ì§ì› B)", type: "clear" },
        ];

        // --- Components ---

        // Detailed Score Modal Component
        const ScoreDetailModal = ({ isOpen, onClose, type }) => {
            if (!isOpen) return null;
            const data = DETAILED_SCORES[type];
            const totalScore = data.reduce((acc, curr) => acc + curr.score, 0);

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full overflow-hidden animate-fade-in">
                        <div className="p-6 border-b flex justify-between items-center bg-gray-50">
                            <div>
                                <h3 className="text-xl font-bold flex items-center gap-2">
                                    <TrendingUp className="text-blue-600"/> 
                                    íš¨ìœ¨ì„± ìŠ¤ì½”ì–´ ìƒì„¸ ë¶„ì„ ë¦¬í¬íŠ¸
                                </h3>
                                <p className="text-sm text-gray-500 mt-1">
                                    {type === 'before' ? 'í˜„ì¬ ë„ë©´ (Before)' : 'ê°œì„  ì œì•ˆ (After)'} ê¸°ì¤€ í‰ê°€í‘œ
                                </p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full transition">
                                <X size={24} className="text-gray-500"/>
                            </button>
                        </div>
                        
                        <div className="p-6">
                            <div className="flex items-center gap-4 mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <div className="text-4xl font-bold text-blue-700">{totalScore}ì </div>
                                <div className="text-sm text-blue-800">
                                    <p className="font-bold">ì¢…í•© í‰ê°€ ì½”ë©˜íŠ¸:</p>
                                    <p>{type === 'before' 
                                        ? "ì£¼ë°©ì˜ êµ¬ì¡°ì  ë¬¸ì œë¡œ ì¸í•´ í”¼í¬íƒ€ì„ ì‹œ ì‹¬ê°í•œ ë™ì„  ì •ì²´ê°€ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì¸ê±´ë¹„ ëˆ„ìˆ˜ê°€ ìš°ë ¤ë©ë‹ˆë‹¤." 
                                        : "ë³‘ëª© êµ¬ê°„ì„ í•´ì†Œí•˜ê³  ë™ì„ ì„ ë‹¨ìˆœí™”í•˜ì—¬ ìš´ì˜ íš¨ìœ¨ì´ 30% ì´ìƒ ê°œì„ ë  ê²ƒìœ¼ë¡œ ì˜ˆì¸¡ë©ë‹ˆë‹¤."}
                                    </p>
                                </div>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left border-collapse">
                                    <thead className="bg-gray-100 text-gray-700 uppercase font-bold text-xs">
                                        <tr>
                                            <th className="px-4 py-3 border">í‰ê°€ í•­ëª©</th>
                                            <th className="px-4 py-3 border text-center">ì ìˆ˜</th>
                                            <th className="px-4 py-3 border">ìƒì„¸ ë¶„ì„ ë‚´ìš©</th>
                                            <th className="px-4 py-3 border">ê°œì„  ë° ì œì•ˆ ì‚¬í•­</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {data.map((item, idx) => (
                                            <tr key={idx} className="hover:bg-gray-50">
                                                <td className="px-4 py-4 border font-medium text-gray-900 w-32">
                                                    {item.category}
                                                </td>
                                                <td className="px-4 py-4 border text-center w-24">
                                                    <div className="flex flex-col items-center">
                                                        <span className={`text-lg font-bold ${item.status === 'Bad' ? 'text-red-500' : item.status === 'Good' ? 'text-green-600' : 'text-yellow-600'}`}>
                                                            {item.score}
                                                        </span>
                                                        <span className="text-xs text-gray-400">/ {item.max}</span>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-4 border text-gray-600 max-w-xs break-keep">
                                                    {item.analysis}
                                                </td>
                                                <td className="px-4 py-4 border text-blue-700 font-medium bg-blue-50/30 max-w-xs break-keep">
                                                    <Icon size={14} className="inline mr-1"/>{item.improvement}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 text-right">
                            <button onClick={onClose} className="px-6 py-2 bg-gray-800 text-white rounded hover:bg-black text-sm font-bold">
                                ë‹«ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const FileUploadStep = ({ onNext }) => {
            return (
                <div className="flex flex-col items-center justify-center h-[600px] border-2 border-dashed border-gray-300 rounded-xl bg-white p-10 hover:bg-gray-50 transition-colors cursor-pointer" onClick={onNext}>
                    <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mb-6">
                        <Upload size={40} className="text-blue-600" />
                    </div>
                    <h2 className="text-2xl font-bold mb-2">ì¸í…Œë¦¬ì–´ ë„ë©´ ì—…ë¡œë“œ</h2>
                    <p className="text-gray-500 mb-8 text-center max-w-md">
                        PDF, PNG, JPG íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”.<br/>
                        (ìƒ˜í”Œ íŒŒì¼: 250821-2_ë¯¸ë¦¬ì¹´í˜ ê´‘í™”ë¬¸ì .pdf)
                    </p>
                    <button className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg flex items-center gap-2">
                        ìƒ˜í”Œ ë„ë©´ìœ¼ë¡œ ì‹œì‘í•˜ê¸° <ArrowRight size={20}/>
                    </button>
                    <div className="mt-8 flex gap-4 text-sm text-gray-400">
                        <span className="flex items-center gap-1"><FileText size={14}/> Sales DB ìë™ ì—°ë™</span>
                        <span className="flex items-center gap-1"><FileText size={14}/> Menu DB ìë™ ì—°ë™</span>
                    </div>
                </div>
            );
        };

        const ProcessingStep = ({ onComplete }) => {
            const [progress, setProgress] = useState(0);
            const [status, setStatus] = useState("ë„ë©´ ë ˆì´ì•„ì›ƒ ë¶„ì„ ì¤‘...");

            useEffect(() => {
                const interval = setInterval(() => {
                    setProgress(prev => {
                        if (prev >= 100) {
                            clearInterval(interval);
                            setTimeout(onComplete, 500);
                            return 100;
                        }
                        if (prev === 30) setStatus("POS ë°ì´í„° ì—°ë™ ì¤‘ (ë¯¸ë¦¬ì¹´í˜ ê´‘í™”ë¬¸ì  Sales DB)...");
                        if (prev === 60) setStatus("ë™ì„  ì‹œë®¬ë ˆì´ì…˜ ì—ì´ì „íŠ¸ ìƒì„± ì¤‘...");
                        if (prev === 90) setStatus("íˆíŠ¸ë§µ ë° íš¨ìœ¨ì„± ìŠ¤ì½”ì–´ë§ ê³„ì‚° ì¤‘...");
                        return prev + 1;
                    });
                }, 50);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="flex flex-col items-center justify-center h-[600px] bg-white rounded-xl">
                    <div className="w-full max-w-md mb-8">
                         <div className="flex justify-between mb-2 text-sm font-medium text-blue-700">
                            <span>{status}</span>
                            <span>{progress}%</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2.5">
                            <div className="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style={{ width: `${progress}%` }}></div>
                        </div>
                    </div>
                    <div className="grid grid-cols-3 gap-4 text-center text-sm text-gray-500 opacity-70">
                        <div className="p-4 border rounded bg-gray-50">
                            <Layout className="mx-auto mb-2"/> ë²½ì²´/ê°€êµ¬ ì¸ì‹
                        </div>
                        <div className="p-4 border rounded bg-gray-50">
                            <TrendingUp className="mx-auto mb-2"/> ë§¤ì¶œ ë°ì´í„° ë§¤í•‘
                        </div>
                        <div className="p-4 border rounded bg-gray-50">
                            <Users className="mx-auto mb-2"/> ì§ì› ë™ì„  ì˜ˆì¸¡
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Simulation Canvas ---
        const FloorPlanCanvas = ({ mode, isPlaying, layoutType }) => {
            const canvasRef = useRef(null);
            const [agents, setAgents] = useState([]);
            
            const getNodes = (type) => {
                if (type === 'before') {
                    return {
                        kitchen: { x: 100, y: 100, w: 100, h: 300, color: '#e2e8f0', label: 'ì£¼ë°©(Deep)' },
                        counter: { x: 200, y: 100, w: 50, h: 100, color: '#cbd5e1', label: 'í”½ì—…' },
                        hall: { x: 250, y: 100, w: 300, h: 300, color: '#f8fafc', label: 'í™€' },
                        terrace: { x: 550, y: 100, w: 100, h: 300, color: '#f1f5f9', label: 'í…Œë¼ìŠ¤' },
                        tables: [
                            {x: 300, y: 150}, {x: 300, y: 250}, {x: 400, y: 150}, {x: 400, y: 250}, // Hall
                            {x: 600, y: 150}, {x: 600, y: 250} // Terrace
                        ]
                    };
                } else {
                    return {
                        kitchen: { x: 100, y: 100, w: 120, h: 250, color: '#e2e8f0', label: 'ì£¼ë°©(Wide)' },
                        counter: { x: 220, y: 150, w: 50, h: 150, color: '#cbd5e1', label: 'í†µí•©ì¹´ìš´í„°' },
                        hall: { x: 270, y: 100, w: 280, h: 300, color: '#f8fafc', label: 'í™€' },
                        terrace: { x: 550, y: 100, w: 100, h: 300, color: '#f1f5f9', label: 'í…Œë¼ìŠ¤' },
                        tables: [
                            {x: 320, y: 130}, {x: 320, y: 220}, {x: 320, y: 310},
                            {x: 450, y: 130}, {x: 450, y: 220},
                            {x: 600, y: 150}, {x: 600, y: 250}
                        ]
                    };
                }
            };

            useEffect(() => {
                if (!isPlaying) return;
                
                const initialAgents = [
                    { id: 1, type: 'cook', x: 120, y: 120, target: {x: 120, y: 250}, color: 'red' },
                    { id: 2, type: 'server', x: 220, y: 120, target: {x: 400, y: 150}, color: 'blue' },
                    { id: 3, type: 'customer', x: 300, y: 300, target: {x: 200, y: 120}, color: 'green' }
                ];
                setAgents(initialAgents);

                const interval = setInterval(() => {
                    setAgents(prev => prev.map(agent => {
                        let dx = agent.target.x - agent.x;
                        let dy = agent.target.y - agent.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        
                        if (dist < 5) {
                            const nodes = getNodes(layoutType);
                            let newTarget = {x: 0, y:0};
                            if(agent.type === 'cook') {
                                newTarget = { x: nodes.kitchen.x + Math.random() * nodes.kitchen.w, y: nodes.kitchen.y + Math.random() * nodes.kitchen.h };
                            } else if (agent.type === 'server') {
                                if(Math.random() > 0.5) {
                                    const table = nodes.tables[Math.floor(Math.random()*nodes.tables.length)];
                                    newTarget = {x: table.x, y: table.y};
                                } else {
                                    newTarget = {x: nodes.counter.x, y: nodes.counter.y};
                                }
                            } else {
                                newTarget = { x: nodes.hall.x + Math.random() * nodes.hall.w, y: nodes.hall.y + Math.random() * nodes.hall.h };
                            }
                            return { ...agent, target: newTarget };
                        }

                        return {
                            ...agent,
                            x: agent.x + (dx / dist) * 2,
                            y: agent.y + (dy / dist) * 2
                        };
                    }));
                }, 20);

                return () => clearInterval(interval);
            }, [isPlaying, layoutType]);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const nodes = getNodes(layoutType);

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const drawZone = (zone) => {
                    ctx.fillStyle = zone.color;
                    ctx.fillRect(zone.x, zone.y, zone.w, zone.h);
                    ctx.strokeStyle = '#94a3b8';
                    ctx.strokeRect(zone.x, zone.y, zone.w, zone.h);
                    ctx.fillStyle = '#64748b';
                    ctx.font = "12px sans-serif";
                    ctx.fillText(zone.label, zone.x + 5, zone.y + 20);
                };

                drawZone(nodes.kitchen);
                drawZone(nodes.counter);
                drawZone(nodes.hall);
                drawZone(nodes.terrace);

                nodes.tables.forEach(t => {
                    ctx.fillStyle = '#e5e7eb';
                    ctx.beginPath();
                    ctx.arc(t.x, t.y, 15, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                });

                if (mode === 'heatmap') {
                    const drawHeat = (x, y, r) => {
                        const grd = ctx.createRadialGradient(x, y, 5, x, y, r);
                        grd.addColorStop(0, "rgba(255, 0, 0, 0.4)");
                        grd.addColorStop(1, "rgba(255, 0, 0, 0)");
                        ctx.fillStyle = grd;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    };
                    
                    if (layoutType === 'before') {
                        drawHeat(nodes.kitchen.x + 50, nodes.kitchen.y + 150, 80);
                        drawHeat(nodes.counter.x, nodes.counter.y + 50, 60);
                    } else {
                        drawHeat(nodes.counter.x, nodes.counter.y + 50, 40);
                    }
                }

                if (mode === 'spaghetti') {
                    ctx.strokeStyle = "rgba(0,0,0,0.1)";
                    ctx.beginPath();
                    for(let i=0; i<20; i++) {
                        ctx.moveTo(nodes.kitchen.x+20, nodes.kitchen.y+20);
                        ctx.bezierCurveTo(300, 200, 200, 300, nodes.terrace.x+20, nodes.terrace.y+50);
                    }
                    ctx.stroke();
                }

                agents.forEach(agent => {
                    ctx.fillStyle = agent.color;
                    ctx.beginPath();
                    ctx.arc(agent.x, agent.y, 6, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'black';
                    ctx.font = '10px sans-serif';
                    ctx.fillText(agent.type === 'cook' ? 'C' : agent.type === 'server' ? 'S' : 'K', agent.x+8, agent.y);
                });

            }, [agents, mode, layoutType]);

            return (
                <div className="relative border rounded-lg overflow-hidden bg-white shadow-inner canvas-grid">
                    <canvas ref={canvasRef} width={700} height={500} className="w-full h-full" />
                    <div className="absolute top-4 left-4 bg-white/90 p-2 rounded shadow text-xs">
                        <div className="flex items-center gap-2 mb-1"><span className="w-2 h-2 rounded-full bg-red-500"></span> ì£¼ë°© ì§ì› (Cook)</div>
                        <div className="flex items-center gap-2 mb-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> í™€ ì§ì› (Server)</div>
                        <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-green-500"></span> ê³ ê° (Customer)</div>
                    </div>
                </div>
            );
        };

        const DashboardStep = () => {
            const [activeTab, setActiveTab] = useState('before');
            const [viewMode, setViewMode] = useState('normal');
            const [isPlaying, setIsPlaying] = useState(false);
            const [showScoreModal, setShowScoreModal] = useState(false);

            return (
                <div className="h-full flex flex-col relative">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-2xl font-bold flex items-center gap-2">
                                <span className="bg-blue-600 text-white px-2 py-1 rounded text-sm">BETA</span>
                                ë¯¸ë¦¬ì¹´í˜ ê´‘í™”ë¬¸ì  ë¶„ì„ ë¦¬í¬íŠ¸
                            </h2>
                            <p className="text-gray-500 text-sm mt-1">
                                ë¶„ì„ ì¼ì‹œ: 2025-11-28 | ë°ì´í„° ì†ŒìŠ¤: ë¯¸ë¦¬ì¹´í˜ ê´‘í™”ë¬¸ì  Sales DB.txt
                            </p>
                        </div>
                        <div className="flex gap-3">
                            <button className="flex items-center gap-2 px-4 py-2 border rounded hover:bg-gray-50 text-sm font-medium" onClick={() => window.location.reload()}>
                                <RefreshCw size={16}/> ë‹¤ì‹œ ë¶„ì„
                            </button>
                            <button className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-bold shadow">
                                <Save size={16}/> ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ (PDF)
                            </button>
                        </div>
                    </div>

                    <div className="flex gap-6 h-full">
                        {/* Left Control Panel */}
                        <div className="w-1/4 flex flex-col gap-4">
                            {/* Score Card (Clickable) */}
                            <div 
                                onClick={() => setShowScoreModal(true)}
                                className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition group relative overflow-hidden"
                            >
                                <div className="absolute top-0 right-0 p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <span className="text-xs bg-gray-900 text-white px-2 py-1 rounded">í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°</span>
                                </div>
                                <h3 className="text-sm font-bold text-gray-500 mb-2 flex items-center gap-1">
                                    ë™ì„  íš¨ìœ¨ì„± ìŠ¤ì½”ì–´ <Info size={14}/>
                                </h3>
                                <div className="flex items-end gap-2 mb-4">
                                    <span className={`text-4xl font-bold ${activeTab === 'before' ? 'text-orange-500' : 'text-green-600'}`}>
                                        {activeTab === 'before' ? '68' : '89'}
                                    </span>
                                    <span className="text-gray-400 mb-1">/ 100ì </span>
                                </div>
                                <div className="text-sm space-y-2">
                                    <div className="flex justify-between">
                                        <span>ì˜ˆìƒ ì¸ê±´ë¹„ ì†ì‹¤</span>
                                        <span className="text-red-500 font-bold">
                                            {activeTab === 'before' ? '- â‚©2,100,000/ì›”' : '- â‚©320,000/ì›”'}
                                        </span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>í”¼í¬íƒ€ì„ ëŒ€ê¸°</span>
                                        <span className="font-medium">
                                            {activeTab === 'before' ? '24ë¶„' : '11ë¶„'}
                                        </span>
                                    </div>
                                </div>
                                <div className="mt-4 pt-3 border-t text-center">
                                    <span className="text-blue-600 text-sm font-bold flex items-center justify-center gap-1">
                                        ìƒì„¸ ë¶„ì„ í‘œ ë³´ê¸° <ArrowRight size={14}/>
                                    </span>
                                </div>
                            </div>

                            {/* Controls */}
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex-1">
                                <h3 className="font-bold mb-4">ì‹œê°í™” ì„¤ì •</h3>
                                <div className="space-y-3 mb-6">
                                    <button 
                                        onClick={() => setViewMode('normal')}
                                        className={`w-full text-left px-4 py-3 rounded border transition ${viewMode === 'normal' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:bg-gray-50'}`}
                                    >
                                        ğŸ‘€ ê¸°ë³¸ ë·° (Agents)
                                    </button>
                                    <button 
                                        onClick={() => setViewMode('heatmap')}
                                        className={`w-full text-left px-4 py-3 rounded border transition ${viewMode === 'heatmap' ? 'border-red-500 bg-red-50 text-red-700' : 'border-gray-200 hover:bg-gray-50'}`}
                                    >
                                        ğŸ”¥ íˆíŠ¸ë§µ (Bottleneck)
                                    </button>
                                    <button 
                                        onClick={() => setViewMode('spaghetti')}
                                        className={`w-full text-left px-4 py-3 rounded border transition ${viewMode === 'spaghetti' ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-gray-200 hover:bg-gray-50'}`}
                                    >
                                        ğŸœ ìŠ¤íŒŒê²Œí‹° ë‹¤ì´ì–´ê·¸ë¨
                                    </button>
                                </div>

                                <div className="border-t pt-4">
                                    <h3 className="font-bold mb-2">ì‹œë®¬ë ˆì´ì…˜ ë¡œê·¸</h3>
                                    <div className="h-40 overflow-y-auto text-xs space-y-2 text-gray-600 bg-gray-50 p-2 rounded">
                                        {SIMULATION_LOGS.map((log, i) => (
                                            <div key={i} className={`flex gap-2 ${log.type === 'warning' ? 'text-red-600 font-bold' : ''}`}>
                                                <span className="text-gray-400">[{log.time}]</span>
                                                <span>{log.event}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Center Canvas */}
                        <div className="w-3/4 flex flex-col">
                            {/* Tabs */}
                            <div className="flex gap-2 mb-2">
                                <button 
                                    onClick={() => setActiveTab('before')}
                                    className={`px-6 py-2 rounded-t-lg font-bold text-sm transition ${activeTab === 'before' ? 'bg-white text-blue-600 shadow-sm' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'}`}
                                >
                                    í˜„ì¬ ë„ë©´ (Before)
                                </button>
                                <button 
                                    onClick={() => setActiveTab('after')}
                                    className={`px-6 py-2 rounded-t-lg font-bold text-sm transition ${activeTab === 'after' ? 'bg-white text-green-600 shadow-sm' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'}`}
                                >
                                    âœ¨ ê°œì„  ì œì•ˆ (After)
                                </button>
                                <div className="ml-auto flex gap-2">
                                     <button 
                                        onClick={() => setIsPlaying(!isPlaying)}
                                        className="px-4 py-1 bg-gray-800 text-white rounded text-sm hover:bg-black flex items-center gap-2"
                                    >
                                        {isPlaying ? <Pause size={14}/> : <Play size={14}/>}
                                        {isPlaying ? "ì¼ì‹œì •ì§€" : "ì‹œë®¬ë ˆì´ì…˜ ì¬ìƒ"}
                                    </button>
                                </div>
                            </div>

                            {/* Canvas Wrapper */}
                            <div className="flex-1 bg-white p-4 rounded-b-xl rounded-tr-xl shadow-sm border border-gray-100">
                                <FloorPlanCanvas mode={viewMode} isPlaying={isPlaying} layoutType={activeTab} />
                                
                                {/* Insights Panel below canvas */}
                                <div className="mt-4 grid grid-cols-2 gap-4">
                                    <div className="bg-red-50 p-4 rounded border border-red-100">
                                        <h4 className="font-bold text-red-800 flex items-center gap-2 mb-2">
                                            <AlertTriangle size={16}/> ì£¼ìš” ë³‘ëª© êµ¬ê°„ (Before)
                                        </h4>
                                        <ul className="text-sm text-red-700 list-disc pl-5 space-y-1">
                                            <li>ì£¼ë°© ê¹Šì´(Depth)ê°€ 3.5më¡œ <strong>ë¯¸ë¦¬ ìŠ¤í˜ì…œ í”Œë˜í„° ì¡°ë¦¬ í›„ í”½ì—…ëŒ€ ì´ë™</strong>ì— í‰ê·  7ì´ˆ ì†Œìš”.</li>
                                            <li>ì ì‹¬ í”¼í¬(12:00) í…Œë¼ìŠ¤ ì„œë¹™ ì‹œ í™€ ì¤‘ì•™ í…Œì´ë¸”ê³¼ <strong>42íšŒ ì¶©ëŒ</strong> ë°œìƒ.</li>
                                        </ul>
                                    </div>
                                    <div className="bg-green-50 p-4 rounded border border-green-100">
                                        <h4 className="font-bold text-green-800 flex items-center gap-2 mb-2">
                                            <CheckCircle size={16}/> ê°œì„  íš¨ê³¼ ì˜ˆì¸¡
                                        </h4>
                                        <ul className="text-sm text-green-700 list-disc pl-5 space-y-1">
                                            <li>ì£¼ë°© ê°€ë¡œ ë°°ì¹˜ ë³€ê²½ìœ¼ë¡œ <strong>ì´ë™ ê±°ë¦¬ 45% ë‹¨ì¶•</strong>.</li>
                                            <li>ìŒë£Œ ë””ìŠ¤íœì„œ ì „ì§„ ë°°ì¹˜ë¡œ í™€ ì§ì›ì˜ ì£¼ë°© ì§„ì… íšŸìˆ˜ <strong>ì¼ 120íšŒ ê°ì†Œ</strong>.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Detailed Score Modal */}
                    <ScoreDetailModal 
                        isOpen={showScoreModal} 
                        onClose={() => setShowScoreModal(false)} 
                        type={activeTab}
                    />
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [step, setStep] = useState(1);

            return (
                <div className="min-h-screen bg-gray-50 p-8">
                    {/* Top Nav */}
                    <nav className="flex justify-between items-center mb-8 px-4">
                        <div className="flex items-center gap-2 text-blue-700">
                            <RotateCw className="animate-spin-slow" size={32}/>
                            <span className="text-2xl font-black tracking-tighter">StoreFlow AI</span>
                        </div>
                        <div className="flex gap-4 text-sm font-medium text-gray-500">
                            <span className={step === 1 ? "text-blue-600" : ""}>1. ë„ë©´ ì—…ë¡œë“œ</span>
                            <span>â†’</span>
                            <span className={step === 2 ? "text-blue-600" : ""}>2. AI ë¶„ì„ & ì‹œë®¬ë ˆì´ì…˜</span>
                            <span>â†’</span>
                            <span className={step === 3 ? "text-blue-600" : ""}>3. ê²°ê³¼ ë¦¬í¬íŠ¸</span>
                        </div>
                    </nav>

                    <div className="max-w-7xl mx-auto">
                        {step === 1 && <FileUploadStep onNext={() => setStep(2)} />}
                        {step === 2 && <ProcessingStep onComplete={() => setStep(3)} />}
                        {step === 3 && <DashboardStep />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
